# ============================================================
# CONTINUOUS INTEGRATION PIPELINE
# Runs on every push and pull request
# Purpose: Ensure code quality before it can be merged
# ============================================================

name: CI Pipeline

on:
  push:
    branches: [main, develop, "feature/**"]
  pull_request:
    branches: [main]

jobs:
  # -----------------------------------------------------------
  # JOB 1: LINT
  # Check code formatting and style
  # WHY: Consistent code style makes reviews easier and
  #      catches common bugs (unused imports, undefined vars)
  # -----------------------------------------------------------
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8 linter
        run: flake8 app/ --max-line-length=120 --statistics

  # -----------------------------------------------------------
  # JOB 2: TEST
  # Run unit tests
  # WHY: Automated tests catch bugs before they reach production.
  #      If tests fail, the pipeline stops — code can't be merged.
  # -----------------------------------------------------------
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r app/requirements.txt

      - name: Run pytest
        run: |
          cd app
          python -m pytest tests/ -v --tb=short --junitxml=../test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

  # -----------------------------------------------------------
  # JOB 3: SECURITY SCAN
  # Scan for vulnerabilities in code and dependencies
  # WHY: DevSecOps — security is shifted left into the pipeline.
  #      Catches known CVEs in dependencies before deployment.
  # -----------------------------------------------------------
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          exit-code: "1"    # Fail the pipeline on critical/high vulnerabilities
          format: "table"

  # -----------------------------------------------------------
  # JOB 4: BUILD DOCKER IMAGE
  # Build the container image to verify it works
  # WHY: Catches Dockerfile errors and ensures the multi-stage
  #      build (including tests inside Docker) succeeds
  # -----------------------------------------------------------
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test]    # Only build if lint and tests pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: false    # Don't push yet — just verify it builds
          tags: deploy-tracker:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # -----------------------------------------------------------
  # JOB 5: HELM LINT
  # Validate the Helm chart
  # WHY: Catches YAML syntax errors and template issues
  #      before attempting a deployment
  # -----------------------------------------------------------
  helm-lint:
    name: Helm Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "v3.14.0"

      - name: Lint Helm chart
        run: helm lint helm/deploy-tracker/

      - name: Template with dev values
        run: |
          helm template deploy-tracker helm/deploy-tracker/ \
            -f helm/deploy-tracker/values-dev.yaml

      - name: Template with prod values
        run: |
          helm template deploy-tracker helm/deploy-tracker/ \
            -f helm/deploy-tracker/values-prod.yaml